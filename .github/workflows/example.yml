name: Deploy Lambda Go Function

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for AWS authentication
      contents: read   # Required to checkout the repository

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: ${{ github.actor }}

      # Optional: Set up Terraform backend
      - name: Set up backend
        uses: alonch/actions-aws-backend-setup@main
        id: backend
        with:
          instance: go-lambda-example

      # Optional: Set up network infrastructure (VPC, subnets, security groups)
      # When this action runs, Lambda functions will be deployed to private subnets
      # If omitted, Lambda functions will use the default VPC (when EFS is enabled)
      # - name: Set up network
      #   uses: realsensesolutions/actions-aws-network@main
      #   with:
      #     action: destroy

      - name: Deploy Lambda Worker
        id: worker
        uses: ./
        with:
          name: demo-worker
          working-directory: examples
          entrypoint-file: main.go
          memory: 256
          timeout: 15
          worker: true  # Enable worker mode with SQS queue
          permissions: |
            s3: read
            dynamodb: write
            ses: write
            cognito: write
            secretsmanager: read

      # Deploy the Lambda function with Chrome layer
      - name: Deploy Lambda Web
        id: deploy
        uses: ./
        with:
          name: demo
          working-directory: examples
          entrypoint-file: main.go
          memory: 1024  # Chrome requires at least 512MB, 1024MB+ recommended
          timeout: 30
          allow-public-access: true
          dd-tracing: true
          dd-api-key: ${{ secrets.DATADOG_API_KEY }}
          packages: |
            chrome: 143
          env: |
            DD_SITE: us5.datadoghq.com
            DD_SERVICE: demo-service
            DD_ENV: staging
            DD_VERSION: ${{ github.sha }}
          permissions: |
            s3: read
            sqs: write
            sns: write
            cloudwatch: write
            dsql: write
            
      # Optional: Test tenant isolation mode (uncomment to test)
      # - name: Deploy Lambda with Tenant Isolation
      #   id: tenant-isolated
      #   uses: ./
      #   with:
      #     name: demo-tenant-isolated
      #     working-directory: examples
      #     entrypoint-file: main.go
      #     memory: 256
      #     timeout: 15
      #     tenant-isolation-mode: PER_TENANT
      #     # Note: allow-public-access is automatically skipped when tenant isolation is enabled
      #     env: |
      #       DD_SITE: us5.datadoghq.com
      #       DD_SERVICE: demo-tenant-service
      #       DD_ENV: staging
      #       DD_VERSION: ${{ github.sha }}
      #       SERVICE_PROVIDER_ID: inrush
      #     permissions: |
      #       s3: read
      #       sqs: write
      
      # Output the created resources
      - name: Output Lambda info
        run: |
          echo "Lambda ARN: ${{ steps.deploy.outputs.arn }}"
          echo "Lambda URL: ${{ steps.deploy.outputs.url }}"
          echo "Queue ARN: ${{ steps.worker.outputs.queue-arn }}"
          echo "Queue Name: ${{ steps.worker.outputs.queue-name }}"
          echo "Queue URL: ${{ steps.worker.outputs.queue-url }}"
        shell: bash
      
      # Verify Chrome layer is attached to the web function
      - name: Verify Chrome Layer
        run: |
          echo "Verifying Chrome layer is attached to Lambda function..."
          LAYERS=$(aws lambda get-function --function-name ${{ steps.deploy.outputs.arn }} --query 'Configuration.Layers[*].Arn' --output text)
          echo "Attached layers: $LAYERS"
          if [[ "$LAYERS" == *"chromium"* ]]; then
            echo "✅ Chrome layer is correctly attached!"
          else
            echo "❌ Chrome layer not found in Lambda configuration"
            exit 1
          fi
        shell: bash